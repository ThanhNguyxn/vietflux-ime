name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Build Complete Web Package (all platforms)
  # ============================================
  build:
    name: ðŸ“¦ Build Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM
        run: |
          cd core
          wasm-pack build --target web --release

      - name: Create Release Package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          # Create package directory
          mkdir -p "VietFlux-${VERSION}"

          # Copy WASM files
          cp -r core/pkg "VietFlux-${VERSION}/wasm"

          # Copy web demo
          cp platforms/web/index.html "VietFlux-${VERSION}/"

          # Update index.html to use local WASM
          sed -i 's|import init.*|import init from "./wasm/vietflux_core.js";|' "VietFlux-${VERSION}/index.html" 2>/dev/null || true

          # Create README for users
          cat > "VietFlux-${VERSION}/README.txt" << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âš¡ VietFlux IME v${VERSION}                   â•‘
          â•‘         Bá»™ gÃµ tiáº¿ng Viá»‡t hiá»‡u nÄƒng cao                     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          CÃCH Sá»¬ Dá»¤NG:
          â•â•â•â•â•â•â•â•â•â•â•â•â•
          1. Má»Ÿ file "index.html" trong trÃ¬nh duyá»‡t (Chrome, Firefox, Edge)
          2. Báº¯t Ä‘áº§u gÃµ tiáº¿ng Viá»‡t!

          PHÃM Táº®T TELEX:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          aa â†’ Ã¢     ee â†’ Ãª     oo â†’ Ã´
          aw â†’ Äƒ     ow â†’ Æ¡     uw â†’ Æ°
          dd â†’ Ä‘
          s â†’ sáº¯c    f â†’ huyá»n   r â†’ há»i   x â†’ ngÃ£   j â†’ náº·ng

          PHÃM Táº®T VNI:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          1 â†’ sáº¯c    2 â†’ huyá»n   3 â†’ há»i   4 â†’ ngÃ£   5 â†’ náº·ng
          6 â†’ mÅ©     7 â†’ mÃ³c     8 â†’ trÄƒng  9 â†’ Ä‘

          GitHub: https://github.com/ThanhNguyxn/vietflux-ime
          EOF

          # Replace ${VERSION} in README
          sed -i "s/\${VERSION}/${VERSION}/g" "VietFlux-${VERSION}/README.txt"

          # Create Windows batch file
          cat > "VietFlux-${VERSION}/Run-VietFlux.bat" << 'EOF'
          @echo off
          echo Opening VietFlux IME...
          start "" "index.html"
          EOF

          # Create macOS/Linux shell script  
          cat > "VietFlux-${VERSION}/run-vietflux.sh" << 'EOF'
          #!/bin/bash
          echo "Opening VietFlux IME..."
          if command -v xdg-open &> /dev/null; then
              xdg-open index.html
          elif command -v open &> /dev/null; then
              open index.html
          else
              echo "Please open index.html in your browser"
          fi
          EOF
          chmod +x "VietFlux-${VERSION}/run-vietflux.sh"

          # Create zip for Windows
          zip -r "VietFlux-${VERSION}-Windows.zip" "VietFlux-${VERSION}"

          # Create tar.gz for Linux/macOS
          tar -czvf "VietFlux-${VERSION}-Linux-macOS.tar.gz" "VietFlux-${VERSION}"

      - name: Get tag message
        id: tag_message
        run: |
          git fetch origin tag ${{ github.ref_name }} --force
          TAG_MSG=$(git for-each-ref --format='%(contents)' refs/tags/${{ github.ref_name }})
          {
            echo "message<<EOF"
            echo "$TAG_MSG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.zip
            *.tar.gz
          body: |
            ## ðŸ“¥ HÆ°á»›ng dáº«n cÃ i Ä‘áº·t

            ### Windows
            1. Táº£i `VietFlux-${{ github.ref_name }}-Windows.zip`
            2. Giáº£i nÃ©n
            3. Double-click `Run-VietFlux.bat` hoáº·c má»Ÿ `index.html`

            ### macOS / Linux
            1. Táº£i `VietFlux-${{ github.ref_name }}-Linux-macOS.tar.gz`
            2. Giáº£i nÃ©n: `tar -xzf VietFlux-*.tar.gz`
            3. Cháº¡y: `./run-vietflux.sh` hoáº·c má»Ÿ `index.html`

            ---
            ${{ steps.tag_message.outputs.message }}
          generate_release_notes: ${{ steps.tag_message.outputs.message == '' }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
